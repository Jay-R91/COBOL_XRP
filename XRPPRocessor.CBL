IDENTIFICATION DIVISION.
PROGRAM-ID. XRP-PROCESSOR.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT BALANCE-FILE ASSIGN TO "balance.dat"
        ORGANIZATION IS LINE SEQUENTIAL
        ACCESS MODE IS SEQUENTIAL
        FILE STATUS IS FILE-STATUS.

DATA DIVISION.
FILE SECTION.
FD BALANCE-FILE.
01 BALANCE-RECORD.
    05 BALANCE-AMOUNT   PIC 9(5)V99.

WORKING-STORAGE SECTION.
01 FILE-STATUS          PIC X(2).
01 AMOUNT               PIC 9(5)V99.
01 SENDER               PIC X(20).
01 RECEIVER             PIC X(20).
01 WS-BALANCE           PIC 9(5)V99.
01 WS-DISPLAY-BALANCE   PIC ---,---,--9.99.
01 WS-RAW-BALANCE       PIC X(10).
01 WS-TEMP-BALANCE      PIC 9(7)V99.

PROCEDURE DIVISION.
MAIN-PROCEDURE SECTION.
    PERFORM INITIALIZE-BALANCE
    PERFORM GET-INPUT
    PERFORM PROCESS-TRANSACTION
    STOP RUN.

INITIALIZE-BALANCE SECTION.
    OPEN I-O BALANCE-FILE
    IF FILE-STATUS = "00" OR FILE-STATUS = "35"  *> 35 = file not found
        MOVE 10000.00 TO BALANCE-AMOUNT
        WRITE BALANCE-RECORD
        DISPLAY "Init File status: " FILE-STATUS
        CLOSE BALANCE-FILE
    ELSE
        DISPLAY "Failed to initialize balance.dat. Status: " FILE-STATUS
        CLOSE BALANCE-FILE
    END-IF
    OPEN INPUT BALANCE-FILE
    IF FILE-STATUS = "00"
        READ BALANCE-FILE INTO WS-RAW-BALANCE
            AT END
                DISPLAY "Init read failed, forcing default."
                MOVE 10000.00 TO WS-BALANCE
                CLOSE BALANCE-FILE
                OPEN OUTPUT BALANCE-FILE
                MOVE WS-BALANCE TO BALANCE-AMOUNT
                WRITE BALANCE-RECORD
                CLOSE BALANCE-FILE
            NOT AT END
                PERFORM CONVERT-RAW-BALANCE
                MOVE WS-BALANCE TO WS-DISPLAY-BALANCE
                DISPLAY "Read balance: " WS-DISPLAY-BALANCE
            END-READ
        CLOSE BALANCE-FILE
    END-IF.

GET-INPUT SECTION.
    OPEN INPUT BALANCE-FILE
    IF FILE-STATUS = "00"
        READ BALANCE-FILE INTO WS-RAW-BALANCE
            AT END
                DISPLAY "File empty, using default balance."
                MOVE 10000.00 TO WS-BALANCE
                MOVE WS-BALANCE TO WS-DISPLAY-BALANCE
                DISPLAY "Read balance: " WS-DISPLAY-BALANCE
            NOT AT END
                PERFORM CONVERT-RAW-BALANCE
                MOVE WS-BALANCE TO WS-DISPLAY-BALANCE
                DISPLAY "Read balance: " WS-DISPLAY-BALANCE
            END-READ
        CLOSE BALANCE-FILE
    ELSE
        DISPLAY "Failed to open balance.dat. Status: " FILE-STATUS
        MOVE 10000.00 TO WS-BALANCE
        MOVE WS-BALANCE TO WS-DISPLAY-BALANCE
        DISPLAY "Current Balance: " WS-DISPLAY-BALANCE
    END-IF
    DISPLAY "Current Balance: " WS-DISPLAY-BALANCE
    DISPLAY "Enter sender name: "
    ACCEPT SENDER
    DISPLAY "Enter receiver name: "
    ACCEPT RECEIVER
    DISPLAY "Enter amount to send: "
    ACCEPT AMOUNT.

PROCESS-TRANSACTION SECTION.
    IF AMOUNT IS NUMERIC
        IF AMOUNT > WS-BALANCE
            DISPLAY "Insufficient funds. Transaction cancelled."
        ELSE
            COMPUTE WS-TEMP-BALANCE = WS-BALANCE - AMOUNT
            MOVE WS-TEMP-BALANCE TO WS-BALANCE
            MOVE WS-BALANCE TO WS-DISPLAY-BALANCE
            DISPLAY "Processing transaction..."
            DISPLAY "From: " SENDER
            DISPLAY "To: " RECEIVER
            MOVE AMOUNT TO WS-DISPLAY-BALANCE
            DISPLAY "Amount: " WS-DISPLAY-BALANCE
            MOVE WS-BALANCE TO WS-DISPLAY-BALANCE
            DISPLAY "New Balance: " WS-DISPLAY-BALANCE
            COMPUTE WS-TEMP-BALANCE = WS-BALANCE * 100  *> Convert to integer form
            MOVE FUNCTION INTEGER(WS-TEMP-BALANCE) TO WS-BALANCE
            MOVE WS-BALANCE TO BALANCE-AMOUNT
            OPEN I-O BALANCE-FILE
            IF FILE-STATUS = "00"
                REWRITE BALANCE-RECORD
                DISPLAY "Rewrite File status: " FILE-STATUS
                CLOSE BALANCE-FILE
            ELSE
                DISPLAY "Failed to rewrite balance.dat. Status: " FILE-STATUS
            END-IF
            DISPLAY "Transaction sent successfully!"
        END-IF
    ELSE
        DISPLAY "Invalid amount entered. Must be a number."
    END-IF.

CONVERT-RAW-BALANCE SECTION.
    MOVE FUNCTION NUMVAL(WS-RAW-BALANCE) TO WS-TEMP-BALANCE
    COMPUTE WS-BALANCE ROUNDED = WS-TEMP-BALANCE
    IF WS-BALANCE > 99999.99
        MOVE 99999.99 TO WS-BALANCE
    END-IF.

END PROGRAM XRP-PROCESSOR.
